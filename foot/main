import cv2
import numpy as np

# 1) ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸°
img = cv2.imread('ë°•ì§€ìœ¤.jpg')
gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)

# 2) ì´ì§„í™” (threshold)
_, thresh = cv2.threshold(gray, 128, 255, cv2.THRESH_BINARY_INV)

# 3) ìœ¤ê³½ì„  ê²€ì¶œ
contours, _ = cv2.findContours(thresh, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
# ê°€ì¥ í° contourë¥¼ ë°œë°”ë‹¥ ìœ¤ê³½ìœ¼ë¡œ ê°„ì£¼
cnt = max(contours, key=cv2.contourArea)

# 4) ì•„ì¹˜ ë¶€ë¶„ í•„í„°ë§ (ì˜ˆ: ì¤‘ê°„ 30â€“60% ë†’ì´ì— í•´ë‹¹í•˜ëŠ” ì ë§Œ ê³¨ë¼ë‚´ê¸°)
# ë°”ìš´ë”© ë°•ìŠ¤ height, y ìœ„ì¹˜ ê³„ì‚°
x,y,w,h = cv2.boundingRect(cnt)
arch_min = int(y + 0.3*h)
arch_max = int(y + 0.6*h)
arch_pts = [pt[0] for pt in cnt if arch_min < pt[0][1] < arch_max]

# 5) xì¶• ë°©í–¥ ì •ë ¬ í›„ ì¢Œí‘œ ì €ì¥
arch_pts = sorted(arch_pts, key=lambda p: p[0])
with open('arch_coords.csv','w') as f:
    f.write('x_pixel,y_pixel\n')
    for x_pix,y_pix in arch_pts:
        f.write(f'{x_pix},{y_pix}\n')


# ìœ¤ê³½ì„  ê²€ì¶œ: ì „ì²´ ì¡±ì ì—ì„œ ì™¸ë¶€ í…Œë‘ë¦¬(contour) ì¶”ì¶œ
# ì•„ì¹˜ ë¶€ë¶„ë§Œ í•„í„°ë§: ì´ë¯¸ì§€ ë†’ì´ì˜ ì¤‘ê°„ êµ¬ê°„(30â€“60%)ì— ìˆëŠ” ì ë“¤ì„ ëª¨ìŒ
# ì¢Œí‘œ CSV: ğ‘¥
# x í”½ì…€ê°’ ìˆœì„œëŒ€ë¡œ ì €ì¥




# ì´ì°¨í•¨ìˆ˜ íšŒê·€ ë° ê·¸ë˜í”„

import numpy as np
import matplotlib.pyplot as plt
import pandas as pd

# CSV ë¶ˆëŸ¬ì˜¤ê¸°
df = pd.read_csv('arch_coords.csv')
x = df['x_pixel'] * scale
y = df['y_pixel'] * scale

# 2ì°¨ íšŒê·€
coeffs = np.polyfit(x, y, 2)   # [a, b, c]
y_fit = np.polyval(coeffs, x)

# ê·¸ë˜í”„
plt.scatter(x,y, label='ì¸¡ì • ì•„ì¹˜ ê³¡ì„ ')
plt.plot(x, y_fit, color='red', label=f'$y={coeffs[0]:.3e}x^2+{coeffs[1]:.3f}x+{coeffs[2]:.3f}$')
plt.xlabel('ë°œ ê¸¸ì´ ìœ„ì¹˜ (cm)')
plt.ylabel('ì•„ì¹˜ ë†’ì´ (cm)')
plt.legend()
plt.show()
